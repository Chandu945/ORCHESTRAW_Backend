// ----------------------------------------------------------------------
// 1. CONFIGURATION
// ----------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url = env("DATABASE_URL")   // <- uncomment & set in .env
}


// ----------------------------------------------------------------------
// 2. ENUMS (Only user/auth related)
// ----------------------------------------------------------------------

enum UserRole {
  USER
  ARKESTA
  ADMIN
  SUPER_ADMIN
}


enum AuthProvider {
  LOCAL
  GOOGLE
}

enum OtpType {
  SIGNUP
  PASSWORD_RESET
  EMAIL_VERIFY
}

enum BandAccountStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
}

enum BandOtpPurpose {
  EMAIL_VERIFY
  PASSWORD_RESET
}



// ----------------------------------------------------------------------
// 3. USER & AUTH DOMAIN
// ----------------------------------------------------------------------

model User {
  id                        String       @id @default(uuid())
  firstName                 String       @map("first_name")
  lastName                  String?      @map("last_name")
  email                     String       @unique
  phoneNumber               String?      @unique @map("phone_number")

  // Auth fields
  passwordHash              String?      @map("password_hash")
  provider                  AuthProvider @default(LOCAL)
  googleId                  String?      @unique

  role                      UserRole     @default(USER)

  // Verification
  isEmailVerified           Boolean      @default(false) @map("is_email_verified")

  // Security
  currentHashedRefreshToken String?

  // Profile Image
  profileImageUrl           String?      @map("profile_image_url")

  // Timestamps
  createdAt                 DateTime     @default(now()) @map("created_at")
  updatedAt                 DateTime     @updatedAt @map("updated_at")

  // Relations
  adminLogs                 AdminLog[]
  otps                      EmailOtp[]

  @@map("users")
}



// ----------------------------------------------------------------------
// 4. OTP MODEL (for login/signup/reset)
// ----------------------------------------------------------------------

model EmailOtp {
  id           String   @id @default(uuid())
  email        String
  otpCode      String   @map("otp_code")
  otpHash      String
  type         OtpType
  attemptCount Int      @default(0)
  expiresAt    DateTime @map("expires_at")
  isUsed       Boolean  @default(false) @map("is_used")
  createdAt    DateTime @default(now()) @map("created_at")

  // Optional User Link
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, type, isUsed])
  @@map("email_otp")
}



// ----------------------------------------------------------------------
// 5. RESET TOKEN (Password reset flow)
// ----------------------------------------------------------------------

model ResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ----------------------------------------------------------------------
// 7. ADMIN LOGS (Admin actions audit)
// ----------------------------------------------------------------------

model AdminLog {
  id          String   @id @default(uuid())
  adminId     String   @map("admin_id")
  action      String
  targetId    String   @map("target_id")
  targetTable String   @map("target_table")
  ipAddress   String?  @map("ip_address")
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at")

  admin       User     @relation(fields: [adminId], references: [id])

  @@map("admin_activity_logs")
}


// ----------------------------------------------------------------------
// 8. BAND ACCOUNT & AUTHENTICATION DOMAIN
// ----------------------------------------------------------------------

model BandAccount {
  id               String   @id @default(uuid())
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  bandName         String   @map("band_name")
  ownerName        String   @map("owner_name")

  email            String   @unique
  phoneNumber      String   @unique @map("phone_number")
  passwordHash     String   @map("password_hash")

  emailVerified    Boolean  @default(false) @map("email_verified")
  status           BandAccountStatus @default(PENDING_VERIFICATION)

  refreshTokenHash String?  @map("refresh_token_hash")

  otps             BandOtp[]

  @@map("band_accounts")
}

model BandOtp {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now()) @map("created_at")

  bandAccountId String   @map("band_account_id")
  bandAccount   BandAccount @relation(fields: [bandAccountId], references: [id], onDelete: Cascade)

  purpose     BandOtpPurpose
  codeHash    String   @map("code_hash")
  expiresAt   DateTime @map("expires_at")
  usedAt      DateTime? @map("used_at")

  attempts    Int      @default(0)
  lastSentAt  DateTime? @map("last_sent_at")

  @@index([bandAccountId, purpose])
  @@map("band_otps")
}

// 8. ORCHESTRAW STANDALONE AUTH DOMAIN
// ----------------------------------------------------------------------

enum OrchestrawAccountStatus {
  ACTIVE
  SUSPENDED
}

enum OrchestrawOtpPurpose {
  EMAIL_VERIFY
  PASSWORD_RESET
}

model OrchestrawAccount {
  id               String                      @id @default(uuid())
  createdAt        DateTime                    @default(now()) @map("created_at")
  updatedAt        DateTime                    @updatedAt @map("updated_at")
  displayName      String                      @map("display_name")
  contactName      String                      @map("contact_name")
  email            String                      @unique
  phoneNumber      String                      @unique @map("phone_number")
  passwordHash     String                      @map("password_hash")
  emailVerified    Boolean                     @default(true) @map("email_verified")
  status           OrchestrawAccountStatus     @default(ACTIVE)
  refreshTokenHash String?                     @map("refresh_token_hash")
  otps             OrchestrawOtp[]

  @@map("orchestraw_accounts")
}

model OrchestrawOtp {
  id         String                   @id @default(uuid())
  createdAt  DateTime                 @default(now()) @map("created_at")
  email      String
  purpose    OrchestrawOtpPurpose
  codeHash   String                   @map("code_hash")
  expiresAt  DateTime                 @map("expires_at")
  usedAt     DateTime?                @map("used_at")
  attempts   Int                      @default(0)
  lastSentAt DateTime?                @map("last_sent_at")
  accountId  String?                  @map("account_id")
  account    OrchestrawAccount?       @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([email, purpose])
  @@map("orchestraw_otps")
}
